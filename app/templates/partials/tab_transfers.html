<div>
  <h2>Traspasos</h2>
  <p class="muted">Traspasa stock entre ubicaciones (multi-producto).</p>

  {% from 'components/ui.html' import flash %}
  {{ flash(message, message_class or '', message_detail) }}

  <form hx-post="/ui/transfers" hx-target="#tab-content" hx-swap="innerHTML" hx-indicator="#transfer-loading" hx-sync="this:drop" hx-disabled-elt="#transfer-submit" class="card" id="transfer-form">
    <div class="grid-3" style="gap:12px;">
      <div>
        <label class="filter-label">Origen</label>
        <select name="from_location_code" required
                hx-get="/ui/transfers/product-options" hx-trigger="change" hx-target="#transfer-products-list" hx-swap="innerHTML" hx-include="#transfer-form">
          {% for loc in all_locations %}
            <option value="{{ loc['code'] }}" {% if (from_location_code or default_from_location_code) == loc['code'] %}selected{% endif %}>{{ loc['name'] }}</option>
          {% endfor %}
        </select>
      </div>
      <div>
        <label class="filter-label">Destino</label>
        <select name="to_location_code" required>
          {% for loc in all_locations %}
            <option value="{{ loc['code'] }}" {% if (to_location_code or default_to_location_code) == loc['code'] %}selected{% endif %}>{{ loc['name'] }}</option>
          {% endfor %}
        </select>
      </div>
      <div>
        <label class="filter-label">Fecha</label>
        <input type="datetime-local" name="movement_date" value="{{ movement_date_default or '' }}" />
      </div>
    </div>

    <div class="row" style="margin-top:10px; grid-template-columns: auto 1fr;">
      <label>Nota</label>
      <input type="text" name="note" value="{{ note_value or '' }}" placeholder="Opcional" style="margin:0;" />
    </div>

    <div class="mt-12"></div>

    <div class="overflow-x-auto">
      <table class="w-full table-fixed">
        <thead>
          <tr>
            <th style="width:62%;">Producto</th>
            <th style="width:23%;">Cantidad</th>
            <th style="width:15%;"></th>
          </tr>
        </thead>
        <tbody id="transfer-lines">
          {% if preserved_lines %}
            {% for line in preserved_lines %}
          <tr>
            <td>
              <input type="text" name="product" list="transfer-products-list" placeholder="Buscar por SKU o nombre" value="{{ line.product or '' }}" />
            </td>
            <td>
              <input type="number" step="0.01" min="0" name="quantity" value="{{ line.quantity or '' }}" />
            </td>
            <td class="text-right">
              <button type="button" class="mb-0" data-transfer-toggle-edit>Bloquear</button>
              <button type="button" class="mb-0" data-transfer-remove-line>Eliminar</button>
            </td>
          </tr>
            {% endfor %}
          {% else %}
          <tr>
            <td>
              <input type="text" name="product" list="transfer-products-list" placeholder="Buscar por SKU o nombre" />
            </td>
            <td>
              <input type="number" step="0.01" min="0" name="quantity" value="" />
            </td>
            <td class="text-right">
              <button type="button" class="mb-0" data-transfer-toggle-edit>Bloquear</button>
              <button type="button" class="mb-0" data-transfer-remove-line>Eliminar</button>
            </td>
          </tr>
          {% endif %}
        </tbody>
      </table>
    </div>

    <datalist id="transfer-products-list">
      {% for p in product_options %}
        <option value="{{ p.sku }} - {{ p.name }}"></option>
      {% endfor %}
    </datalist>

    <template id="transfer-line-template">
      <tr>
        <td>
          <input type="text" name="product" list="transfer-products-list" placeholder="Buscar por SKU o nombre" />
        </td>
        <td>
          <input type="number" step="0.01" min="0" name="quantity" value="" />
        </td>
        <td class="text-right">
          <button type="button" class="mb-0" data-transfer-toggle-edit>Bloquear</button>
          <button type="button" class="mb-0" data-transfer-remove-line>Eliminar</button>
        </td>
      </tr>
    </template>

    <div class="mt-12 flex gap-10 items-center">
      <button type="button" class="mb-0" data-transfer-add-line>Agregar línea</button>
      <button id="transfer-submit" type="submit" class="mb-0">Crear traspaso</button>
      <span id="transfer-loading" class="htmx-indicator" style="margin-left: 10px;">Procesando...</span>
      {% if transfer_ref %}
        <a href="/ui/transfers/print?ref={{ transfer_ref }}" target="_blank" class="text-sm">Imprimir</a>
      {% endif %}
      <a href="#" hx-get="/ui/tabs/transfers" hx-target="#tab-content" hx-swap="innerHTML" class="text-sm">Limpiar</a>
    </div>
  </form>

  <div class="mt-16"></div>

  <h3>Filtrar historial</h3>
  <form hx-get="/ui/tabs/transfers" hx-target="#transfers-history" hx-select="#transfers-history" hx-swap="outerHTML" class="card mb-12"
        hx-trigger="submit, keyup changed delay:300ms from:#transfers-filter-query, change from:#transfers-filter-start, change from:#transfers-filter-end, change from:#transfers-filter-from, change from:#transfers-filter-to">
    <input type="hidden" name="from_location_code" value="{{ from_location_code or '' }}" />
    <input type="hidden" name="to_location_code" value="{{ to_location_code or '' }}" />
    <div class="flex gap-12 items-center flex-wrap">
      <div>
        <label class="filter-label">Buscar artículo</label>
        <input id="transfers-filter-query" type="text" name="query" value="{{ filter_query or '' }}" placeholder="SKU o nombre" />
      </div>
      <div>
        <label class="filter-label">Origen</label>
        <select id="transfers-filter-from" name="filter_from_location_code">
          <option value="" {% if not (filter_from_location_code or '') %}selected{% endif %}>Todos</option>
          {% for loc in all_locations %}
            <option value="{{ loc['code'] }}" {% if (filter_from_location_code or '') == loc['code'] %}selected{% endif %}>{{ loc['name'] }}</option>
          {% endfor %}
        </select>
      </div>
      <div>
        <label class="filter-label">Destino</label>
        <select id="transfers-filter-to" name="filter_to_location_code">
          <option value="" {% if not (filter_to_location_code or '') %}selected{% endif %}>Todos</option>
          {% for loc in all_locations %}
            <option value="{{ loc['code'] }}" {% if (filter_to_location_code or '') == loc['code'] %}selected{% endif %}>{{ loc['name'] }}</option>
          {% endfor %}
        </select>
      </div>
      <div>
        <label class="filter-label">Desde</label>
        <input id="transfers-filter-start" type="date" name="start_date" value="{{ filter_start_date or '' }}" />
      </div>
      <div>
        <label class="filter-label">Hasta</label>
        <input id="transfers-filter-end" type="date" name="end_date" value="{{ filter_end_date or '' }}" />
      </div>
      <button type="submit" class="mb-0">Filtrar</button>
      <a href="/ui/tabs/transfers" hx-get="/ui/tabs/transfers" hx-target="#tab-content" hx-swap="innerHTML" class="text-sm">Limpiar</a>
    </div>
  </form>

  <div id="transfers-history">
    {% set can_manage = user and ((user.role or '')|lower == 'admin' or (user.role or '')|lower == 'owner') %}
    {% if can_manage %}
    <form hx-post="/ui/movement/transfer/delete-selected"
          hx-target="#tab-content"
          hx-swap="innerHTML">
      <div class="flex gap-12 items-center flex-wrap" style="margin: 8px 0 10px 0;">
        <button type="submit" class="mb-0" hx-confirm="¿Eliminar los traspasos seleccionados?">Eliminar seleccionados</button>
      </div>
    {% endif %}

    <h3>Últimos traspasos (salida)</h3>
    <div class="table-wrapper" style="-webkit-overflow-scrolling: touch;">
      <table class="table-compact transfer-table">
        <thead>
          <tr>
            {% if can_manage %}
            <th style="width:3%;">
              <input type="checkbox" aria-label="Seleccionar todo"
                     onclick="const f=this.closest('form'); if(!f) return; f.querySelectorAll('input[name=movement_ids]').forEach(cb=>cb.checked=this.checked);" />
            </th>
            {% endif %}
            <th class="col-date">Fecha</th>
            <th style="width: 120px;">Tipo</th>
            <th style="width: 140px;">Usuario</th>
            <th style="width: 140px;">SKU</th>
            <th>Producto</th>
            <th style="width: 110px;" class="text-right">Cantidad</th>
            <th style="width: 110px;">Origen</th>
            <th style="width: 110px;">Destino</th>
            <th style="width: 110px;">Acciones</th>
          </tr>
        </thead>
        <tbody>
          {% for id, d, type, location_id, sku, name, uom, qty, unit_cost, unit_price, note, username in recent_transfer_out %}
          <tr>
            {% if can_manage %}
            <td>
              <input type="checkbox" name="movement_ids" value="{{ id }}" aria-label="Seleccionar traspaso {{ id }}" />
            </td>
            {% endif %}
            <td class="text-left col-date">{{ d.strftime('%Y-%m-%d %H:%M') if d else '' }}</td>
            <td class="text-left">Traspaso (salida)</td>
            <td class="text-left muted">{{ username or '' }}</td>
            <td class="text-left"><code>{{ sku }}</code></td>
            <td class="text-left">{{ name }}</td>
            <td class="text-right nowrap">{{ "%.2f"|format(qty) }}</td>
            {% set from_code = '-' %}
            {% set to_code = '-' %}
            {% if note and 'Transfer ' in note and '->' in note %}
              {% set tmp = note.split('Transfer ', 1)[1] %}
              {% set from_code = (tmp.split('->', 1)[0] or '-').strip() %}
              {% set to_code = (tmp.split('->', 1)[1].split()[0] if ('->' in tmp and (tmp.split('->', 1)|length) > 1) else '-') %}
            {% endif %}
            <td class="text-left muted nowrap">{{ from_code }}</td>
            <td class="text-left muted nowrap">{{ to_code }}</td>
            <td class="text-left">
              {% if can_manage %}
                <div class="transfer-actions-inline">
                {% set ref = '' %}
                {% if note and 'ref=' in note %}{% set ref = note.split('ref=', 1)[1].split()[0] %}{% endif %}
                {% if ref %}
                  <a href="/ui/transfers/print?ref={{ ref }}" target="_blank" style="text-decoration:none;">
                    <button type="button">Print</button>
                  </a>
                {% endif %}
                <button type="button"
                        hx-get="/ui/movement/transfer/{{ id }}/edit"
                        hx-target="body"
                        hx-swap="beforeend">Edit</button>
                </div>
              {% endif %}
            </td>
          </tr>
          {% else %}
          <tr>
            <td colspan="{{ 10 if can_manage else 9 }}" class="muted text-center">No hay traspasos registrados.</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <h3>Últimos traspasos (entrada)</h3>
    <div class="table-wrapper" style="-webkit-overflow-scrolling: touch;">
      <table class="table-compact transfer-table">
        <thead>
          <tr>
            {% if can_manage %}
            <th style="width:3%;"></th>
            {% endif %}
            <th class="col-date">Fecha</th>
            <th style="width: 120px;">Tipo</th>
            <th style="width: 140px;">Usuario</th>
            <th style="width: 140px;">SKU</th>
            <th>Producto</th>
            <th style="width: 110px;" class="text-right">Cantidad</th>
            <th style="width: 110px;">Origen</th>
            <th style="width: 110px;">Destino</th>
            <th style="width: 110px;">Acciones</th>
          </tr>
        </thead>
        <tbody>
          {% for id, d, type, location_id, sku, name, uom, qty, unit_cost, unit_price, note, username in recent_transfer_in %}
          <tr>
            {% if can_manage %}
            <td>
              <input type="checkbox" name="movement_ids" value="{{ id }}" aria-label="Seleccionar traspaso {{ id }}" />
            </td>
            {% endif %}
            <td class="text-left col-date">{{ d.strftime('%Y-%m-%d %H:%M') if d else '' }}</td>
            <td class="text-left">Traspaso (entrada)</td>
            <td class="text-left muted">{{ username or '' }}</td>
            <td class="text-left"><code>{{ sku }}</code></td>
            <td class="text-left">{{ name }}</td>
            <td class="text-right nowrap">{{ "%.2f"|format(qty) }}</td>
            {% set from_code = '-' %}
            {% set to_code = '-' %}
            {% if note and 'Transfer in from ' in note %}
              {% set tmp = note.split('Transfer in from ', 1)[1] %}
              {% set from_code = (tmp.split()[0] if tmp else '-') %}
            {% endif %}
            {% set ref = '' %}
            {% if note and 'ref=' in note %}{% set ref = note.split('ref=', 1)[1].split()[0] %}{% endif %}
            {% if ref and ref.startswith('TP-') %}
              {% set ref_parts = ref.split('-') %}
              {% if (ref_parts|length) >= 3 %}
                {% set to_code = ref_parts[2] %}
              {% endif %}
            {% endif %}
            <td class="text-left muted nowrap">{{ from_code }}</td>
            <td class="text-left muted nowrap">{{ to_code }}</td>
            <td class="text-left">
              {% if can_manage %}
                <div class="transfer-actions-inline">
                {% if ref %}
                  <a href="/ui/transfers/print?ref={{ ref }}" target="_blank" style="text-decoration:none;">
                    <button type="button">Print</button>
                  </a>
                {% endif %}
                <button type="button"
                        hx-get="/ui/movement/transfer/{{ id }}/edit"
                        hx-target="body"
                        hx-swap="beforeend">Edit</button>
                </div>
              {% endif %}
            </td>
          </tr>
          {% else %}
          <tr>
            <td colspan="{{ 10 if can_manage else 9 }}" class="muted text-center">No hay traspasos registrados.</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    {% if can_manage %}
    </form>
    {% endif %}
  </div>

  <div id="transfer-edit" style="margin-top:12px;"></div>
</div>
