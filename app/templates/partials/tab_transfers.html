<div>
  <h2>Envíos</h2>
  <p class="muted">Envía stock desde CENTRAL hacia un punto de venta (multi-producto).</p>

  {% from 'components/ui.html' import flash %}
  {{ flash(message, message_class or '', message_detail) }}

  <form hx-post="/ui/transfers" hx-target="#tab-content" hx-swap="innerHTML" hx-indicator="#transfer-loading" hx-sync="this:drop" hx-disabled-elt="#transfer-submit" class="card" id="transfer-form">
    <div class="grid-3" style="gap:12px;">
      <div>
        <label class="filter-label">Destino</label>
        <select name="to_location_code" required>
          {% for loc in pos_locations %}
            <option value="{{ loc['code'] }}" {% if (to_location_code or default_to_location_code) == loc['code'] %}selected{% endif %}>{{ loc['name'] }}</option>
          {% endfor %}
        </select>
      </div>
      <div>
        <label class="filter-label">Fecha</label>
        <input type="datetime-local" name="movement_date" value="{{ movement_date_default or '' }}" />
      </div>
      <div>
        <label class="filter-label">Nota</label>
        <input type="text" name="note" value="{{ note_value or '' }}" placeholder="Opcional" />
      </div>
    </div>

    <div class="mt-12"></div>

    <div class="overflow-x-auto">
      <table class="w-full table-fixed">
        <thead>
          <tr>
            <th style="width:62%;">Producto</th>
            <th style="width:23%;" class="text-right">Cantidad</th>
            <th style="width:15%;"></th>
          </tr>
        </thead>
        <tbody id="transfer-lines">
          {% if preserved_lines %}
            {% for line in preserved_lines %}
          <tr>
            <td>
              <input type="text" name="product" list="transfer-products-list" placeholder="Buscar por SKU o nombre" value="{{ line.product or '' }}" />
            </td>
            <td class="text-right">
              <input type="number" step="0.01" min="0" name="quantity" value="{{ line.quantity or '' }}" />
            </td>
            <td class="text-right">
              <button type="button" class="mb-0" data-transfer-toggle-edit>Bloquear</button>
              <button type="button" class="mb-0" data-transfer-remove-line>Eliminar</button>
            </td>
          </tr>
            {% endfor %}
          {% else %}
          <tr>
            <td>
              <input type="text" name="product" list="transfer-products-list" placeholder="Buscar por SKU o nombre" />
            </td>
            <td class="text-right">
              <input type="number" step="0.01" min="0" name="quantity" value="" />
            </td>
            <td class="text-right">
              <button type="button" class="mb-0" data-transfer-toggle-edit>Bloquear</button>
              <button type="button" class="mb-0" data-transfer-remove-line>Eliminar</button>
            </td>
          </tr>
          {% endif %}
        </tbody>
      </table>
    </div>

    <datalist id="transfer-products-list">
      {% for p in product_options %}
        <option value="{{ p.sku }}">{{ p.sku }} - {{ p.name }}</option>
      {% endfor %}
    </datalist>

    <template id="transfer-line-template">
      <tr>
        <td>
          <input type="text" name="product" list="transfer-products-list" placeholder="Buscar por SKU o nombre" />
        </td>
        <td class="text-right">
          <input type="number" step="0.01" min="0" name="quantity" value="" />
        </td>
        <td class="text-right">
          <button type="button" class="mb-0" data-transfer-toggle-edit>Bloquear</button>
          <button type="button" class="mb-0" data-transfer-remove-line>Eliminar</button>
        </td>
      </tr>
    </template>

    <div class="mt-12 flex gap-10 items-center">
      <button type="button" class="mb-0" data-transfer-add-line>Agregar línea</button>
      <button id="transfer-submit" type="submit" class="mb-0">Crear envío</button>
      <span id="transfer-loading" class="htmx-indicator" style="margin-left: 10px;">Procesando...</span>
      <a href="#" hx-get="/ui/tabs/transfers" hx-target="#tab-content" hx-swap="innerHTML" class="text-sm">Limpiar</a>
    </div>
  </form>

  <div class="mt-16"></div>

  <h3>Últimos envíos (entrada)</h3>
  <div class="overflow-x-auto" style="-webkit-overflow-scrolling: touch;">
    <table class="w-full table-compact" style="min-width: 900px;">
      <thead>
        <tr>
          <th style="width:16%;">Fecha</th>
          <th style="width:9%;">Tipo</th>
          <th style="width:10%;">Usuario</th>
          <th style="width:9%;">SKU</th>
          <th style="width:26%;">Producto</th>
          <th style="width:10%;" class="text-right">Cantidad</th>
          <th style="width:20%;">Nota</th>
        </tr>
      </thead>
      <tbody>
        {% for mv in recent_transfer_in %}
        <tr>
          <td class="text-left nowrap">{{ mv.movement_date.strftime('%Y-%m-%d %H:%M') if mv.movement_date else '' }}</td>
          <td class="text-left">Envío (entrada)</td>
          <td class="text-left muted">{{ mv.username or '' }}</td>
          <td class="text-left"><code>{{ mv.sku }}</code></td>
          <td class="text-left">{{ mv.name }}</td>
          <td class="text-right nowrap">{{ "%.2f"|format(mv.quantity) }}</td>
          <td class="text-left muted truncate" title="{{ mv.note or '' }}">{{ mv.note or '' }}</td>
        </tr>
        {% else %}
        <tr>
          <td colspan="7" class="muted text-center">No hay envíos registrados.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
