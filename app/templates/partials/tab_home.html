<div>
  {% from 'components/ui.html' import metric, chart_card %}
  <h2>Inicio</h2>
  <p class="muted">Resumen general (lo iremos ampliando paso a paso).</p>

  <form class="home-charts-filter" hx-get="/ui/tabs/home" hx-target="#tab-content" hx-swap="innerHTML" hx-trigger="change">
    <label class="home-charts-filter-label">Ubicación</label>
    <select class="home-charts-filter-input" name="location_code">
      {% for loc in locations %}
        <option value="{{ loc.code }}" {% if (selected_location_code or '') == (loc.code or '') %}selected{% endif %}>{{ loc.name }}</option>
      {% endfor %}
    </select>
    <input type="hidden" name="ym" value="{{ selected_ym }}" />
    <input type="hidden" name="metrics_start_date" value="{{ metrics_start_date_value or '' }}" />
    <input type="hidden" name="metrics_end_date" value="{{ metrics_end_date_value or '' }}" />
  </form>

  <div class="grid-3">
    {{ metric('Productos', totals.products) }}
    {{ metric('Stock total', '%.0f'|format(totals.stock_total or 0)) }}
    {{ metric('Por reponer', totals.to_restock) }}
  </div>

  <div class="grid-3 mt-12">
    {{ metric('Inventario total (valor a costo)', '%.2f'|format(inventory_value_total or 0) ~ ' €', 'Estimación en base a lotes FIFO (stock actual).', 'medium') }}
    {{ metric('Inventario total (valor a venta)', '%.2f'|format(inventory_sale_value_total or 0) ~ ' €', 'Estimación en base a precios de venta actuales.', 'medium') }}
    {{ metric('Gasto operativo que más impacta (' ~ month_label ~ ')', (top_expense.concept if top_expense else '-'), ('%.2f'|format(top_expense.total or 0) ~ ' €' if top_expense else ''), 'medium') }}
  </div>

  <div class="grid-3 mt-12">
    {{ metric('Más vendido (año ' ~ year ~ ')', (top_year.name if top_year else '-'), (top_year.sku ~ ' - ' ~ '%.2f'|format(top_year.sales or 0) ~ ' € (' ~ '%.1f'|format(top_year_pct or 0) ~ '%)' if top_year else ''), 'medium') }}
    {{ metric('Menos vendido (año ' ~ year ~ ')', (bottom_year.name if bottom_year else '-'), (bottom_year.sku ~ ' - ' ~ '%.2f'|format(bottom_year.sales or 0) ~ ' € (' ~ '%.1f'|format(bottom_year_pct or 0) ~ '%)' if bottom_year else ''), 'medium') }}
    {{ metric('Mayor margen % (' ~ month_label ~ ')', (top_margin.name if top_margin else '-'), (top_margin.sku ~ ' - ' ~ '%.2f'|format(top_margin.gross_pct or 0) ~ '%' if top_margin else ''), 'medium') }}
  </div>

  <div id="home-charts">
    {% include 'partials/home_charts.html' %}
  </div>
</div>
