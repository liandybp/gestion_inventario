<div id="purchases-history">
  {% set can_manage = user and ((user.role or '')|lower == 'admin' or (user.role or '')|lower == 'owner') %}
  {% if can_manage %}
  <form hx-post="/ui/movement/purchase/delete-selected"
        hx-target="#purchase-panel"
        hx-swap="outerHTML">
    <div class="flex gap-12 items-center flex-wrap" style="margin: 8px 0 10px 0;">
      <button type="submit" class="mb-0" hx-confirm="Â¿Eliminar las compras seleccionadas?">Eliminar seleccionados</button>
    </div>
  {% endif %}
  <div class="table-wrapper">
  <table>
    <thead>
      <tr>
        {% if can_manage %}
        <th>
          <input type="checkbox" aria-label="Seleccionar todo"
                 onclick="const f=this.closest('form'); if(!f) return; f.querySelectorAll('input[name=movement_ids]').forEach(cb=>cb.checked=this.checked);" />
        </th>
        {% endif %}
        <th class="col-date">Fecha</th>
        <th>Img</th>
        <th>SKU</th>
        <th>Nombre</th>
        <th>Unidad</th>
        <th>Cant.</th>
        <th>Costo</th>
        <th>Lote</th>
        <th>Barcode</th>
        {% if can_manage %}
        <th>Acciones</th>
        {% endif %}
      </tr>
    </thead>
    <tbody>
      {% for id, d, sku, name, uom, image_url, qty, unit_cost, lot_code in purchases %}
        <tr>
          {% if can_manage %}
          <td>
            <input type="checkbox" name="movement_ids" value="{{ id }}" aria-label="Seleccionar compra {{ id }}" />
          </td>
          {% endif %}
          <td class="col-date">{{ d.strftime('%Y-%m-%d %H:%M') if d else '' }}</td>
          <td>
            {% if image_url %}
              <img src="{{ image_url }}" alt="" style="width:36px;height:36px;object-fit:cover;border-radius:8px;border:1px solid #e5e7eb;" />
            {% endif %}
          </td>
          <td>{{ sku }}</td>
          <td>{{ name }}</td>
          <td>{{ uom or '' }}</td>
          <td>{{ '%.0f'|format(qty or 0) }}</td>
          <td>{{ '%.2f'|format(unit_cost or 0) }}</td>
          {% set lot_disp = (lot_code[:-5] if lot_code and lot_code.endswith('00000') else lot_code) %}
          <td>{{ lot_disp or '' }}</td>
          <td>
            {% if sku %}
              <div style="display:flex; align-items:center; gap:8px;">
                <svg class="barcode" data-code="{{ sku }}"></svg>
                <a href="/ui/purchase/{{ id }}/label?copies={{ (qty|int) if (qty|int) > 0 else 1 }}&auto_print=1" target="_blank" style="text-decoration:none;">
                  <button type="button">Print</button>
                </a>
              </div>
            {% endif %}
          </td>
          {% if can_manage %}
          <td>
            <button type="button"
                    hx-get="/ui/movement/purchase/{{ id }}/edit"
                    hx-target="body"
                    hx-swap="beforeend">Edit</button>
          </td>
          {% endif %}
        </tr>
      {% endfor %}
    </tbody>
  </table>
  </div>
  {% if can_manage %}
  </form>
  {% endif %}
</div>
