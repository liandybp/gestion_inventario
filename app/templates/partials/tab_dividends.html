<div>
  {% from 'components/ui.html' import flash %}
  <h2>Dividendos</h2>
  <p class="muted">Resumen del mes corriente (costo de venta, costos operativos, utilidad neta y reparto 50/50). Registra y edita retiros para calcular lo pendiente.</p>

  {{ flash(message, message_class or '', message_detail) }}

  <div class="grid-2">
    <div class="card">
      <h3>DIVIDENDOS</h3>
      <table>
        <thead>
          <tr>
            <th></th>
            <th>{{ dividends.business_label }}</th>
            {% for p in dividends.partners %}
              <th>{{ p }}</th>
            {% endfor %}
          </tr>
        </thead>
        <tbody>
          <tr>
            <th>Inversión de mercancía</th>
            <td>{{ '%.2f'|format(summary.cogs_total or 0) }}</td>
            {% for p in dividends.partners %}
              <td class="muted">-</td>
            {% endfor %}
          </tr>
          <tr>
            <th>Costos de operaciones</th>
            <td>{{ '%.2f'|format(summary.expenses_total or 0) }}</td>
            {% for p in dividends.partners %}
              <td class="muted">-</td>
            {% endfor %}
          </tr>
          <tr>
            <th>Utilidades (50% cada uno)</th>
            <td class="muted">-</td>
            {% for p in dividends.partners %}
              <td>{{ '%.2f'|format(summary.share_each or 0) }}</td>
            {% endfor %}
          </tr>
          <tr>
            <th>Retiros (-)</th>
            <td>{{ '%.2f'|format(summary.extractions[dividends.business_label] or 0) }}</td>
            {% for p in dividends.partners %}
              <td>{{ '%.2f'|format(summary.extractions[p] or 0) }}</td>
            {% endfor %}
          </tr>
          <tr>
            <th>Total pendiente</th>
            <td class="font-bold">{{ '%.2f'|format(summary.pending[dividends.business_label] or 0) }}</td>
            {% for p in dividends.partners %}
              <td class="font-bold">{{ '%.2f'|format(summary.pending[p] or 0) }}</td>
            {% endfor %}
          </tr>
        </tbody>
      </table>
    </div>

    <div class="card">
      <h3>Registrar retiro</h3>
      <form hx-post="/ui/extractions/create" hx-target="#tab-content" hx-swap="innerHTML">
        <div class="row"><label>Fecha</label><input name="extraction_date" type="datetime-local" value="{{ movement_date_default or '' }}" /></div>
        <div class="row">
          <label>Parte</label>
          <select name="party">
            <option value="{{ dividends.business_label }}">{{ dividends.business_label }}</option>
            {% for p in dividends.partners %}
              <option value="{{ p }}">{{ p }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="row"><label>Cantidad</label><input name="amount" type="number" step="0.0001" required /></div>
        <div class="row"><label>Concepto</label><input name="concept" required /></div>
        <button type="submit">Guardar</button>
      </form>

      <div id="extraction-edit" class="mt-12"></div>

      <div class="card mt-16">
        <h3>Retiros (mes corriente)</h3>
        <table>
          <thead>
            <tr>
              <th>Concepto</th>
              <th>{{ dividends.business_label }}</th>
              {% for p in dividends.partners %}
                <th>{{ p }}</th>
              {% endfor %}
              <th>Fecha</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody>
            {% for r in extractions %}
              <tr>
                <td>{{ r.concept }}</td>
                <td>{% if r.party == dividends.business_label %}{{ '%.2f'|format(r.amount or 0) }}{% else %}<span class="muted">-</span>{% endif %}</td>
                {% for p in dividends.partners %}
                  <td>{% if r.party == p %}{{ '%.2f'|format(r.amount or 0) }}{% else %}<span class="muted">-</span>{% endif %}</td>
                {% endfor %}
                <td>{{ r.extraction_date.strftime('%Y-%m-%d %H:%M') if r.extraction_date else '' }}</td>
                <td>
                  <button type="button"
                          hx-get="/ui/extraction/{{ r.id }}/edit"
                          hx-target="#extraction-edit"
                          hx-swap="innerHTML">Edit</button>

                  <button type="button" class="ml-8 btn-danger"
                          hx-post="/ui/extraction/{{ r.id }}/delete"
                          hx-target="#tab-content"
                          hx-swap="innerHTML"
                          hx-confirm="¿Eliminar este retiro?">Del</button>
                </td>
              </tr>
            {% endfor %}
            {% if not extractions %}
              <tr><td colspan="6" class="muted">Sin retiros registrados en el mes.</td></tr>
            {% endif %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>
