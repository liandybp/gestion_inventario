<div class="card" id="purchase-panel">
  <h2>Compra</h2>

  {% if user and (user.role or '')|lower == 'admin' %}
  <button type="button" style="background:#b91c1c; margin-bottom:10px;"
          hx-post="/ui/dev/reset-purchases-sales" hx-vals='{"panel":"purchase"}'
          hx-target="#purchase-panel" hx-swap="outerHTML"
          hx-confirm="Esto borrará TODAS las compras y ventas. ¿Continuar?">
    Borrar todas las compras y ventas (DEV)
  </button>
  {% endif %}

  {% if user and (user.role or '')|lower == 'admin' %}
  <h3 style="margin-top:0;">Importar compra desde factura (PDF)</h3>
  <form hx-post="/ui/purchase/from-invoice" hx-target="#purchase-panel" hx-swap="outerHTML" hx-encoding="multipart/form-data" enctype="multipart/form-data" style="margin-bottom:14px;">
    <div class="row">
      <label>Factura (PDF)</label>
      <input name="invoice_pdf" type="file" accept="application/pdf" required />
    </div>
    <button type="submit">Importar factura</button>
  </form>

  {% if invoice_created_products and invoice_created_products|length > 0 %}
    <div class="warn" style="padding:12px;border-radius:10px;margin-top:12px;">
      <strong>Productos creados automáticamente</strong>
      <div class="muted" style="margin-top:6px;">
        Debes completar <strong>precio de venta</strong> y <strong>cantidad mínima</strong> en estos productos.
        El historial mostrará el precio de venta actual cuando lo actualices.
      </div>
      <div style="margin-top:8px;">
        {% for p in invoice_created_products %}
          <div><code>{{ p.sku }}</code> - {{ p.name }}</div>
        {% endfor %}
      </div>
    </div>
  {% endif %}
  {% endif %}

  <form hx-post="/ui/purchase" hx-target="#purchase-panel" hx-swap="outerHTML">
    <div class="row">
      <label>Artículo</label>
      <input name="product" list="product-options" placeholder="Busca por nombre o SKU" required
             hx-get="/ui/product-defaults/purchase" hx-trigger="change" hx-target="#purchase-defaults" hx-swap="innerHTML" />
    </div>
    <div class="row"><label id="purchase-qty-label">Cantidad</label><input name="quantity" type="number" step="0.0001" min="0" required /></div>
    <div class="row"><label>Costo unitario</label><input id="purchase-unit-cost" name="unit_cost" type="number" step="0.0001" min="0" /></div>
    <div class="row"><label>Fecha</label><input name="movement_date" type="datetime-local" value="{{ movement_date_default or '' }}" /></div>
    <div class="row"><label>Lote</label><input name="lot_code" placeholder="(auto si lo dejas vacío)" /></div>
    <div class="row"><label>Nota</label><input name="note" placeholder="(opcional)" /></div>
    <button type="submit">Registrar compra</button>
  </form>

  <div id="purchase-defaults"></div>

  {% if message %}
    <div class="{{ message_class }}" style="padding:12px;border-radius:10px;margin-top:12px;">
      <strong>{{ message }}</strong>
      {% if message_detail %}<div>{{ message_detail }}</div>{% endif %}
    </div>
  {% endif %}

  <h3 style="margin-top:16px;">Historial de compras</h3>
  
  <form hx-get="/ui/tabs/purchases" hx-target="#purchases-history" hx-select="#purchases-history" hx-swap="outerHTML" class="card mb-12"
        hx-trigger="submit, keyup changed delay:300ms from:#purchases-filter-query, change from:#purchases-filter-start, change from:#purchases-filter-end">
    {% if filter_show_all %}<input type="hidden" name="show_all" value="1" />{% endif %}
    <div class="flex gap-12 items-center flex-wrap">
      <div>
        <label class="filter-label">Buscar artículo</label>
        <input id="purchases-filter-query" type="text" name="query" value="{{ filter_query or '' }}" placeholder="SKU o nombre" />
      </div>
      <div>
        <label class="filter-label">Desde</label>
        <input id="purchases-filter-start" type="date" name="start_date" value="{{ filter_start_date or '' }}" />
      </div>
      <div>
        <label class="filter-label">Hasta</label>
        <input id="purchases-filter-end" type="date" name="end_date" value="{{ filter_end_date or '' }}" />
      </div>
      <button type="submit" class="mb-0">Filtrar</button>
      <a href="/ui/tabs/purchases?show_all=1" hx-get="/ui/tabs/purchases?show_all=1" hx-target="#tab-content" hx-swap="innerHTML" class="text-sm">Ver todos</a>
    </div>
  </form>
  
  {% include 'partials/purchases_history.html' %}

  <div id="purchase-edit" style="margin-top:12px;"></div>
</div>
