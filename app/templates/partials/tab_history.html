<div>
  <h2>Historial de Movimientos</h2>
  <p class="muted">Filtra por producto, tipo de movimiento y rango de fechas.</p>

  {% if message %}
  <div class="{{ message_class or '' }}" style="padding:10px;margin-bottom:12px;border-radius:8px;">
    <strong>{{ message }}</strong>
    {% if message_detail %}<br><span class="muted">{{ message_detail }}</span>{% endif %}
  </div>
  {% endif %}

  <form hx-get="/ui/tabs/history" hx-target="#tab-content" hx-swap="innerHTML" style="margin-bottom:16px;">
    <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap:12px; align-items:end;">
      <div>
        <label style="display:block;font-size:13px;margin-bottom:4px;">Producto (SKU)</label>
        <select name="sku" style="width:100%; padding:8px;border-radius:8px;border:1px solid var(--brand-border);">
          <option value="">-- Todos --</option>
          {% for p in product_options %}
          <option value="{{ p.sku }}" {% if sku_filter == p.sku %}selected{% endif %}>{{ p.sku }} - {{ p.name }}</option>
          {% endfor %}
        </select>
      </div>
      <div>
        <label style="display:block;font-size:13px;margin-bottom:4px;">Tipo</label>
        <select name="movement_type" style="width:100%; padding:8px;border-radius:8px;border:1px solid var(--brand-border);">
          <option value="">-- Todos --</option>
          <option value="purchase" {% if type_filter == 'purchase' %}selected{% endif %}>Compra</option>
          <option value="sale" {% if type_filter == 'sale' %}selected{% endif %}>Venta</option>
          <option value="adjustment" {% if type_filter == 'adjustment' %}selected{% endif %}>Ajuste</option>
        </select>
      </div>
      <div>
        <label style="display:block;font-size:13px;margin-bottom:4px;">Desde</label>
        <input type="date" name="start_date" value="{{ start_date_value or '' }}" style="width:100%; padding:8px;border-radius:8px;border:1px solid var(--brand-border);" />
      </div>
      <div>
        <label style="display:block;font-size:13px;margin-bottom:4px;">Hasta</label>
        <input type="date" name="end_date" value="{{ end_date_value or '' }}" style="width:100%; padding:8px;border-radius:8px;border:1px solid var(--brand-border);" />
      </div>
      <div style="display:flex; gap:10px; align-items:center;">
        <button type="submit" style="margin-bottom:0;">Filtrar</button>
        <a href="#" hx-get="/ui/tabs/history" hx-target="#tab-content" hx-swap="innerHTML" style="font-size:13px;">Limpiar filtros</a>
      </div>
    </div>
  </form>

  <div style="overflow-x:auto;">
    <table style="width:100%; table-layout:fixed;">
      <thead>
        <tr>
          <th style="width:12%; text-align:left;">Fecha</th>
          <th style="width:8%; text-align:left;">Tipo</th>
          <th style="width:10%; text-align:left;">Usuario</th>
          <th style="width:8%; text-align:left;">SKU</th>
          <th style="width:25%; text-align:left;">Producto</th>
          <th style="width:7%; text-align:center;">Unidad</th>
          <th style="width:8%; text-align:right;">Cantidad</th>
          <th style="width:10%; text-align:right;">Costo Unit.</th>
          <th style="width:10%; text-align:right;">Precio Unit.</th>
          <th style="width:12%; text-align:left;">Nota</th>
        </tr>
      </thead>
      <tbody>
        {% for mv in movements %}
        <tr>
          <td style="text-align:left;white-space:nowrap;">{{ mv.movement_date.strftime('%Y-%m-%d %H:%M') if mv.movement_date else '' }}</td>
          <td style="text-align:left;">
            {% if mv.type == 'purchase' %}
              <span style="color:#059669;">Compra</span>
            {% elif mv.type == 'sale' %}
              <span style="color:#dc2626;">Venta</span>
            {% elif mv.type == 'adjustment' %}
              <span style="color:#d97706;">Ajuste</span>
            {% else %}
              {{ mv.type }}
            {% endif %}
          </td>
          <td style="text-align:left;" class="muted">{{ mv.username or '' }}</td>
          <td style="text-align:left;"><code>{{ mv.sku }}</code></td>
          <td style="text-align:left;">{{ mv.name }}</td>
          <td style="text-align:center;" class="muted">{{ mv.unit_of_measure or '' }}</td>
          <td style="text-align:right;white-space:nowrap;">
            {% if mv.type == 'sale' %}
              {{ "%.2f"|format(mv.quantity|abs) }}
            {% else %}
              {{ "%.2f"|format(mv.quantity) }}
            {% endif %}
          </td>
          <td style="text-align:right;white-space:nowrap;">{% if mv.unit_cost %}${{ "%.2f"|format(mv.unit_cost) }}{% endif %}</td>
          <td style="text-align:right;white-space:nowrap;">{% if mv.unit_price %}${{ "%.2f"|format(mv.unit_price) }}{% endif %}</td>
          <td style="text-align:left;" class="muted">{{ mv.note or '' }}</td>
        </tr>
        {% else %}
        <tr>
          <td colspan="10" class="muted" style="text-align:center;">No hay movimientos con los filtros seleccionados.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <p class="muted" style="margin-top:12px;">Mostrando {{ movements|length }} movimiento(s).</p>
</div>
