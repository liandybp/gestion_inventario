<div>
  <h2>Historial de Movimientos</h2>
  <p class="muted">Filtra por producto, tipo de movimiento y rango de fechas.</p>

  {% from 'components/ui.html' import flash %}
  {{ flash(message, message_class or '', message_detail) }}

  <form hx-get="/ui/tabs/history" hx-target="#tab-content" hx-swap="innerHTML" class="mb-16">
    <div class="filter-grid">
      <div>
        <label class="filter-label">Producto (SKU)</label>
        <select name="sku">
          <option value="">-- Todos --</option>
          {% for p in product_options %}
          <option value="{{ p.sku }}" {% if sku_filter == p.sku %}selected{% endif %}>{{ p.sku }} - {{ p.name }}</option>
          {% endfor %}
        </select>
      </div>
      <div>
        <label class="filter-label">Tipo</label>
        <select name="movement_type">
          <option value="">-- Todos --</option>
          <option value="purchase" {% if type_filter == 'purchase' %}selected{% endif %}>Compra</option>
          <option value="sale" {% if type_filter == 'sale' %}selected{% endif %}>Venta</option>
          <option value="adjustment" {% if type_filter == 'adjustment' %}selected{% endif %}>Ajuste</option>
        </select>
      </div>
      <div>
        <label class="filter-label">Desde</label>
        <input type="date" name="start_date" value="{{ start_date_value or '' }}" />
      </div>
      <div>
        <label class="filter-label">Hasta</label>
        <input type="date" name="end_date" value="{{ end_date_value or '' }}" />
      </div>
      <div class="flex gap-10 items-center">
        <button type="submit" class="mb-0">Filtrar</button>
        <a href="#" hx-get="/ui/tabs/history" hx-target="#tab-content" hx-swap="innerHTML" class="text-sm">Limpiar filtros</a>
      </div>
    </div>
  </form>

  <div class="overflow-x-auto">
    <table class="w-full table-fixed">
      <thead>
        <tr>
          <th style="width:12%;">Fecha</th>
          <th style="width:8%;">Tipo</th>
          <th style="width:10%;">Usuario</th>
          <th style="width:8%;">SKU</th>
          <th style="width:25%;">Producto</th>
          <th style="width:7%;" class="text-center">Unidad</th>
          <th style="width:8%;" class="text-right">Cantidad</th>
          <th style="width:10%;" class="text-right">Costo Unit.</th>
          <th style="width:10%;" class="text-right">Precio Unit.</th>
          <th style="width:12%;">Nota</th>
        </tr>
      </thead>
      <tbody>
        {% for mv in movements %}
        <tr>
          <td class="text-left nowrap">{{ mv.movement_date.strftime('%Y-%m-%d %H:%M') if mv.movement_date else '' }}</td>
          <td class="text-left">
            {% if mv.type == 'purchase' %}
              <span class="color-purchase">Compra</span>
            {% elif mv.type == 'sale' %}
              <span class="color-sale">Venta</span>
            {% elif mv.type == 'adjustment' %}
              <span class="color-adjustment">Ajuste</span>
            {% else %}
              {{ mv.type }}
            {% endif %}
          </td>
          <td class="text-left muted">{{ mv.username or '' }}</td>
          <td class="text-left"><code>{{ mv.sku }}</code></td>
          <td class="text-left">{{ mv.name }}</td>
          <td class="text-center muted">{{ mv.unit_of_measure or '' }}</td>
          <td class="text-right nowrap">
            {% if mv.type == 'sale' %}
              {{ "%.2f"|format(mv.quantity|abs) }}
            {% else %}
              {{ "%.2f"|format(mv.quantity) }}
            {% endif %}
          </td>
          <td class="text-right nowrap">{% if mv.unit_cost %}${{ "%.2f"|format(mv.unit_cost) }}{% endif %}</td>
          <td class="text-right nowrap">{% if mv.unit_price %}${{ "%.2f"|format(mv.unit_price) }}{% endif %}</td>
          <td class="text-left muted">{{ mv.note or '' }}</td>
        </tr>
        {% else %}
        <tr>
          <td colspan="10" class="muted text-center">No hay movimientos con los filtros seleccionados.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <p class="muted mt-12">Mostrando {{ movements|length }} movimiento(s).</p>
</div>
