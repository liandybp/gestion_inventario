<div>
  <h2>Historial de Movimientos</h2>
  <p class="muted">Filtra por producto, tipo de movimiento y rango de fechas.</p>

  {% from 'components/ui.html' import flash %}
  {{ flash(message, message_class or '', message_detail) }}

  <form hx-get="/ui/tabs/history" hx-target="#tab-content" hx-swap="innerHTML" class="mb-16">
    <div class="filter-grid">
      <div>
        <label class="filter-label">Buscar producto</label>
        <input type="text" name="query" value="{{ filter_query or '' }}" placeholder="SKU o nombre" />
      </div>
      <div>
        <label class="filter-label">Tipo</label>
        <select name="movement_type">
          <option value="">-- Todos --</option>
          <option value="purchase" {% if type_filter == 'purchase' %}selected{% endif %}>Compra</option>
          <option value="sale" {% if type_filter == 'sale' %}selected{% endif %}>Venta</option>
          <option value="adjustment" {% if type_filter == 'adjustment' %}selected{% endif %}>Ajuste</option>
          <option value="transfer_out" {% if type_filter == 'transfer_out' %}selected{% endif %}>Traspaso (salida)</option>
          <option value="transfer_in" {% if type_filter == 'transfer_in' %}selected{% endif %}>Traspaso (entrada)</option>
          <option value="return_supplier" {% if type_filter == 'return_supplier' %}selected{% endif %}>Devolución a proveedor</option>
        </select>
      </div>
      <div>
        <label class="filter-label">Desde</label>
        <input type="date" name="start_date" value="{{ start_date_value or '' }}" />
      </div>
      <div>
        <label class="filter-label">Hasta</label>
        <input type="date" name="end_date" value="{{ end_date_value or '' }}" />
      </div>
      <div class="flex gap-10 items-center">
        <button type="submit" class="mb-0">Filtrar</button>
        <a href="#" hx-get="/ui/tabs/history" hx-target="#tab-content" hx-swap="innerHTML" class="text-sm">Limpiar filtros</a>
      </div>
    </div>
  </form>

  {% set can_manage = user and ((user.role or '')|lower in ['admin','owner']) %}
  {% if can_manage %}
  <form hx-post="/ui/tabs/history/adjustments/delete-selected" hx-target="#tab-content" hx-swap="innerHTML" class="mb-12">
    <input type="hidden" name="query" value="{{ filter_query or '' }}" />
    <input type="hidden" name="movement_type" value="{{ type_filter or '' }}" />
    <input type="hidden" name="start_date" value="{{ start_date_value or '' }}" />
    <input type="hidden" name="end_date" value="{{ end_date_value or '' }}" />
    <div class="flex gap-12 items-center flex-wrap">
      <button type="submit" class="mb-0" hx-confirm="¿Eliminar los ajustes seleccionados?">Eliminar seleccionados</button>
      <span class="muted text-sm">Solo afecta movimientos tipo Ajuste.</span>
    </div>
  {% endif %}

  <div class="table-wrapper">
    <table class="w-full table-fixed">
      <thead>
        <tr>
          {% if can_manage %}
          <th style="width:3%;">
            <input type="checkbox" aria-label="Seleccionar todo"
                   onclick="const f=this.closest('form'); if(!f) return; f.querySelectorAll('input[name=movement_ids]').forEach(cb=>cb.checked=this.checked);" />
          </th>
          {% endif %}
          <th style="width:14%;">Fecha</th>
          <th style="width:8%;">Tipo</th>
          <th style="width:9%;">Usuario</th>
          <th style="width:9%;">SKU</th>
          <th style="width:23%;">Producto</th>
          <th style="width:6%;" class="text-center">Unidad</th>
          <th style="width:7%;" class="text-right">Cantidad</th>
          <th style="width:8%;" class="text-right">Costo Unit.</th>
          <th style="width:8%;" class="text-right">Precio Unit.</th>
          <th style="width:5%;">Nota</th>
        </tr>
      </thead>
      <tbody>
        {% for mv in movements %}
        <tr>
          {% if can_manage %}
          <td>
            {% if mv.type == 'adjustment' %}
              <input type="checkbox" name="movement_ids" value="{{ mv.id }}" aria-label="Seleccionar ajuste {{ mv.id }}" />
            {% endif %}
          </td>
          {% endif %}
          <td class="text-left">
            <div class="truncate" title="{{ mv.movement_date.strftime('%Y-%m-%d %H:%M') if mv.movement_date else '' }}">{{ mv.movement_date.strftime('%Y-%m-%d %H:%M') if mv.movement_date else '' }}</div>
          </td>
          <td class="text-left">
            <div class="truncate" title="{{ mv.type or '' }}">
            {% if mv.type == 'purchase' %}
              <span class="color-purchase">Compra</span>
            {% elif mv.type == 'sale' %}
              <span class="color-sale">Venta</span>
            {% elif mv.type == 'adjustment' %}
              <span class="color-adjustment">Ajuste</span>
            {% elif mv.type == 'transfer_out' %}
              <span>Traspaso (salida)</span>
            {% elif mv.type == 'transfer_in' %}
              <span>Traspaso (entrada)</span>
            {% elif mv.type == 'return_supplier' %}
              <span>Devolución a proveedor</span>
            {% else %}
              {{ mv.type }}
            {% endif %}
            </div>
          </td>
          <td class="text-left muted">{{ mv.username or '' }}</td>
          <td class="text-left"><code>{{ mv.sku }}</code></td>
          <td class="text-left">{{ mv.name }}</td>
          <td class="text-center muted">{{ mv.unit_of_measure or '' }}</td>
          <td class="text-right nowrap">
            {% if mv.type == 'sale' or mv.type == 'transfer_out' or mv.type == 'return_supplier' %}
              {{ "%.2f"|format(mv.quantity|abs) }}
            {% else %}
              {{ "%.2f"|format(mv.quantity) }}
            {% endif %}
          </td>
          <td class="text-right nowrap">{% if mv.unit_cost %}${{ "%.2f"|format(mv.unit_cost) }}{% endif %}</td>
          <td class="text-right nowrap">{% if mv.unit_price %}${{ "%.2f"|format(mv.unit_price) }}{% endif %}</td>
          <td class="text-left muted">
            <div class="truncate" title="{{ mv.note or '' }}">{{ mv.note or '' }}</div>
          </td>
        </tr>
        {% else %}
        <tr>
          <td colspan="{{ 11 if can_manage else 10 }}" class="muted text-center">No hay movimientos con los filtros seleccionados.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  {% if can_manage %}
  </form>
  {% endif %}

  <p class="muted mt-12">Mostrando {{ movements|length }} movimiento(s).</p>
</div>
