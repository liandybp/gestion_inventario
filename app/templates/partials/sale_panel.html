<div class="card" id="sale-panel">
  <h2>Venta</h2>

  {% if user and (user.role or '')|lower == 'admin' %}
  <button type="button" style="background:#b91c1c; margin-bottom:10px;"
          hx-post="/ui/dev/reset-purchases-sales" hx-vals='{"panel":"sale"}'
          hx-target="#sale-panel" hx-swap="outerHTML"
          hx-confirm="Esto borrará TODAS las compras y ventas. ¿Continuar?">
    Borrar todas las compras y ventas (DEV)
  </button>
  {% endif %}

  <div class="grid" style="grid-template-columns: 1fr 1fr; gap:12px; align-items:stretch;">
    <div class="card" style="height:100%; display:flex; flex-direction:column;">
      <h3 style="margin-top:0;">Venta por escáner</h3>
      <p class="muted" style="margin-top:-6px;">Escanea el código y presiona Enter.</p>
      <form hx-post="/ui/sale/barcode" hx-target="#sale-panel" hx-swap="outerHTML">
        <div class="row">
          <label>Ubicación</label>
          <select name="location_code"
                  hx-get="/ui/sale/product-options"
                  hx-trigger="change"
                  hx-target="#product-options"
                  hx-swap="innerHTML">
            {% for loc in pos_locations %}
              <option value="{{ loc['code'] }}" {% if (sale_location_code or default_sale_location_code) == loc['code'] %}selected{% endif %}>{{ loc['name'] }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="row"><label>Barcode</label><input name="barcode" placeholder="Escanea aquí" autocomplete="off" autofocus required /></div>
        <div class="row"><label>Cantidad</label><input name="quantity" type="number" step="0.0001" min="0" value="1" required /></div>
        <div class="row"><label>Precio unitario</label><input name="unit_price" type="number" step="0.0001" min="0" /></div>
        <div class="row"><label>Fecha</label><input name="movement_date" type="datetime-local" value="{{ movement_date_default or '' }}" /></div>
        <div class="row"><label>Nota</label><input name="note" placeholder="(opcional)" /></div>
        <button type="submit">Registrar venta</button>
      </form>
    </div>

    <div class="card" style="height:100%; display:flex; flex-direction:column;">
      <h3 style="margin-top:0;">Venta manual</h3>
      <form hx-post="/ui/sale" hx-target="#sale-panel" hx-swap="outerHTML">
        <div class="row">
          <label>Ubicación</label>
          <select name="location_code"
                  hx-get="/ui/sale/product-options"
                  hx-trigger="change"
                  hx-target="#product-options"
                  hx-swap="innerHTML">
            {% for loc in pos_locations %}
              <option value="{{ loc['code'] }}" {% if (sale_location_code or default_sale_location_code) == loc['code'] %}selected{% endif %}>{{ loc['name'] }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="row">
          <label>Artículo</label>
          <input name="product" list="product-options" placeholder="Busca por nombre o SKU" required
                 hx-get="/ui/product-defaults/sale" hx-trigger="change" hx-target="#sale-defaults" hx-swap="innerHTML" />
        </div>
        <div class="row"><label id="sale-qty-label">Cantidad</label><input name="quantity" type="number" step="0.0001" min="0" required /></div>
        <div class="row"><label>Precio unitario</label><input id="sale-unit-price" name="unit_price" type="number" step="0.0001" min="0" /></div>
        <div class="row"><label>Fecha</label><input name="movement_date" type="datetime-local" value="{{ movement_date_default or '' }}" /></div>
        <div class="row"><label>Nota</label><input name="note" placeholder="(opcional)" /></div>
        <button type="submit">Registrar venta</button>
      </form>
    </div>
  </div>

  <datalist id="product-options">
    {% for p in product_options %}
      <option value="{{ p.sku }} - {{ p.name }}"></option>
    {% endfor %}
  </datalist>

  {% if message %}
    <div class="{{ message_class }}" style="padding:12px;border-radius:10px;margin-top:12px;">
      <strong>{{ message }}</strong>
      {% if message_detail %}<div>{{ message_detail }}</div>{% endif %}
    </div>
  {% endif %}

  <h3 style="margin-top:16px;">Historial de ventas</h3>
  
  <form hx-get="/ui/tabs/sales" hx-target="#tab-content" hx-swap="innerHTML" class="card mb-12">
    <div class="flex gap-12 items-center flex-wrap">
      <div>
        <label class="filter-label">Mes</label>
        <select name="month">
          <option value="">Todos</option>
          <option value="01" {% if filter_month == '01' %}selected{% endif %}>Enero</option>
          <option value="02" {% if filter_month == '02' %}selected{% endif %}>Febrero</option>
          <option value="03" {% if filter_month == '03' %}selected{% endif %}>Marzo</option>
          <option value="04" {% if filter_month == '04' %}selected{% endif %}>Abril</option>
          <option value="05" {% if filter_month == '05' %}selected{% endif %}>Mayo</option>
          <option value="06" {% if filter_month == '06' %}selected{% endif %}>Junio</option>
          <option value="07" {% if filter_month == '07' %}selected{% endif %}>Julio</option>
          <option value="08" {% if filter_month == '08' %}selected{% endif %}>Agosto</option>
          <option value="09" {% if filter_month == '09' %}selected{% endif %}>Septiembre</option>
          <option value="10" {% if filter_month == '10' %}selected{% endif %}>Octubre</option>
          <option value="11" {% if filter_month == '11' %}selected{% endif %}>Noviembre</option>
          <option value="12" {% if filter_month == '12' %}selected{% endif %}>Diciembre</option>
        </select>
      </div>
      <div>
        <label class="filter-label">Año</label>
        <input type="number" name="year" value="{{ filter_year }}" min="2020" max="2099" style="width: 100px;" />
      </div>
      <button type="submit" class="mb-0">Filtrar</button>
      <a href="/ui/tabs/sales?show_all=1" hx-get="/ui/tabs/sales?show_all=1" hx-target="#tab-content" hx-swap="innerHTML" class="text-sm">Ver todos</a>
    </div>
  </form>
  
  {% include 'partials/sales_history.html' %}

  <div id="sale-edit" style="margin-top:12px;"></div>
</div>

<div id="sale-defaults"></div>
