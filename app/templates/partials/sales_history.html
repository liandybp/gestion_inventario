{% set can_manage = user and ((user.role or '')|lower == 'admin' or (user.role or '')|lower == 'owner') %}
{% if can_manage %}
<form hx-post="/ui/movement/sale/delete-selected"
      hx-target="#sale-panel"
      hx-swap="outerHTML">
  <div class="flex gap-12 items-center flex-wrap" style="margin: 8px 0 10px 0;">
    <button type="submit" class="mb-0" hx-confirm="Â¿Eliminar las ventas seleccionadas?">Eliminar seleccionados</button>
  </div>
{% endif %}

<div class="table-wrapper">
<table>
  <thead>
    <tr>
      {% if can_manage %}
      <th>
        <input type="checkbox" aria-label="Seleccionar todo"
               onclick="const f=this.closest('form'); if(!f) return; f.querySelectorAll('input[name=sale_ids]').forEach(cb=>cb.checked=this.checked);" />
      </th>
      {% endif %}
      <th>Fecha</th>
      <th>Img</th>
      <th>SKU</th>
      <th>Nombre</th>
      <th>Unidad</th>
      <th>Cant.</th>
      <th>Precio</th>
      <th>Lote</th>
      <th>Acciones</th>
    </tr>
  </thead>
  <tbody>
    {% for id, d, sku, name, uom, image_url, qty, unit_price, lot_codes in sales %}
      <tr>
        {% if can_manage %}
        <td>
          <input type="checkbox" name="sale_ids" value="{{ id }}" aria-label="Seleccionar venta {{ id }}" />
        </td>
        {% endif %}
        <td>{{ d.strftime('%Y-%m-%d %H:%M') if d else '' }}</td>
        <td>
          {% if image_url %}
            <img src="{{ image_url }}" alt="" style="width:36px;height:36px;object-fit:cover;border-radius:8px;border:1px solid #e5e7eb;" />
          {% endif %}
        </td>
        <td>{{ sku }}</td>
        <td>{{ name }}</td>
        <td>{{ uom or '' }}</td>
        <td>{{ '%.0f'|format(qty or 0) }}</td>
        <td>{{ '%.2f'|format(unit_price or 0) }}</td>
        <td>
          {% if lot_codes %}
            {% set lot_list = lot_codes.split(',') %}
            {% set lot_disp_list = [] %}
            {% for lc in lot_list %}
              {% set lc_trim = (lc[:-5] if lc.endswith('00000') else lc) %}
              {% set _ = lot_disp_list.append(lc_trim) %}
            {% endfor %}
            <span title="{{ lot_codes }}">{{ lot_disp_list|join(', ') }}</span>
          {% endif %}
        </td>
        <td>
          <button type="button"
                  hx-get="/ui/movement/sale/{{ id }}/edit"
                  hx-target="body"
                  hx-swap="beforeend">Edit</button>
        </td>
      </tr>
    {% endfor %}
  </tbody>
</table>
</div>

{% if can_manage %}
</form>
{% endif %}
