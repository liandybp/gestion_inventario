<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Inventario</title>
    <script src="https://unpkg.com/htmx.org@1.9.12"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.6/dist/JsBarcode.all.min.js"></script>
    <link rel="stylesheet" href="/static/css/app.css?v=39" />
    <script src="/static/js/app.js?v=39" defer></script>
  </head>
  <body>
    <button class="mobile-menu-toggle" id="mobile-menu-toggle" aria-label="Abrir menú">
      ☰
    </button>
    <div class="mobile-menu-overlay" id="mobile-menu-overlay"></div>
    
    <div class="app-layout">
      <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
          <h2>Dashboard</h2>
          {% if user %}
            {% set user_role = (user.role or '')|lower %}
            <div class="sidebar-user">{{ user.username }}</div>
            {% if user_role == 'admin' %}
              <div class="muted" style="margin-top:6px;">Negocio: {{ (active_business.name if active_business else 'Recambios') }}</div>
              <form method="post" action="/ui/active-business" style="margin-top:8px;">
                <select name="business_id" onchange="this.form.submit()" style="width:100%; padding:8px; border-radius:10px; border:1px solid var(--brand-border);">
                  {% for b in businesses %}
                    <option value="{{ b.id }}" {% if active_business_id and (active_business_id|int) == (b.id|int) %}selected{% endif %}>{{ b.name }}</option>
                  {% endfor %}
                </select>
              </form>
            {% elif user_role in ('owner', 'operator') %}
              <div class="muted" style="margin-top:6px;">Negocio: {{ (active_business.name if active_business else 'Recambios') }}</div>
            {% endif %}
            <a href="/ui/logout" class="sidebar-logout">Cerrar sesión</a>
          {% endif %}
        </div>
        
        <nav class="sidebar-nav" role="navigation" aria-label="Secciones">
          {% set user_role = (user.role or '')|lower %}
          
          {% if user_role in ('admin', 'owner') %}
          <button class="sidebar-item" id="tab-home" aria-selected="true"
                  hx-get="/ui/tabs/home" hx-target="#tab-content" hx-swap="innerHTML">
            Inicio
          </button>
          <button class="sidebar-item" id="tab-inventory" aria-selected="false"
                  hx-get="/ui/tabs/inventory" hx-target="#tab-content" hx-swap="innerHTML">
            Inventario
          </button>
          <button class="sidebar-item" id="tab-purchases" aria-selected="false"
                  hx-get="/ui/tabs/purchases" hx-target="#tab-content" hx-swap="innerHTML">
            Compras
          </button>
          <button class="sidebar-item" id="tab-transfers" aria-selected="false"
                  hx-get="/ui/tabs/transfers" hx-target="#tab-content" hx-swap="innerHTML">
            Traspasos
          </button>
          {% endif %}

          <button class="sidebar-item" id="tab-sales" aria-selected="{% if user_role == 'operator' %}true{% else %}false{% endif %}"
                  hx-get="/ui/tabs/sales" hx-target="#tab-content" hx-swap="innerHTML">
            Ventas
          </button>

          {% if user_role in ('admin', 'owner') %}
          <button class="sidebar-item" id="tab-documents" aria-selected="false"
                  hx-get="/ui/tabs/documents" hx-target="#tab-content" hx-swap="innerHTML">
            Documentos
          </button>

          <button class="sidebar-item" id="tab-customers" aria-selected="false"
                  hx-get="/ui/tabs/customers" hx-target="#tab-content" hx-swap="innerHTML">
            Clientes
          </button>

          <button class="sidebar-item" id="tab-expenses" aria-selected="false"
                  hx-get="/ui/tabs/expenses" hx-target="#tab-content" hx-swap="innerHTML">
            Costos operativos
          </button>

          <button class="sidebar-item" id="tab-profit-items" aria-selected="false"
                  hx-get="/ui/tabs/profit-items" hx-target="#tab-content" hx-swap="innerHTML">
            Utilidades por artículo
          </button>

          <button class="sidebar-item" id="tab-profit" aria-selected="false"
                  hx-get="/ui/tabs/profit" hx-target="#tab-content" hx-swap="innerHTML">
            Utilidades
          </button>

          <button class="sidebar-item" id="tab-dividends" aria-selected="false"
                  hx-get="/ui/tabs/dividends" hx-target="#tab-content" hx-swap="innerHTML">
            Dividendos
          </button>

          <button class="sidebar-item" id="tab-history" aria-selected="false"
                  hx-get="/ui/tabs/history" hx-target="#tab-content" hx-swap="innerHTML">
            Historial
          </button>
          {% endif %}

          {% if user_role == 'admin' %}
          <button class="sidebar-item" id="tab-users" aria-selected="false"
                  hx-get="/ui/tabs/users" hx-target="#tab-content" hx-swap="innerHTML">
            Usuarios
          </button>

          <button class="sidebar-item" id="tab-activity" aria-selected="false"
                  hx-get="/ui/tabs/activity" hx-target="#tab-content" hx-swap="innerHTML">
            Actividad
          </button>
          {% endif %}
        </nav>
      </aside>

      <main class="main-content">
        <div id="tab-content"
             hx-get="{% if user and (user.role or '')|lower == 'operator' %}/ui/tabs/sales{% else %}/ui/tabs/home{% endif %}" hx-trigger="load" hx-swap="innerHTML">
        </div>
      </main>
    </div>
    
    <div id="modal-container"></div>
    {% if user and user.must_change_password %}
      <div hx-get="/ui/must-change-password-form" hx-trigger="load" hx-target="#modal-container" hx-swap="innerHTML"></div>
    {% endif %}
  </body>
</html>
