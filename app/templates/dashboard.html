<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Inventario</title>
    <script src="https://unpkg.com/htmx.org@1.9.12"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.6/dist/JsBarcode.all.min.js"></script>
    <style>
      :root {
        --brand-navy: #0b2d42;
        --brand-red: #cf1f27;
        --brand-bg: #f8fafc;
        --brand-surface: #ffffff;
        --brand-border: #e5e7eb;
        --brand-text: #0f172a;
        --brand-muted: #64748b;
        --row-odd: rgba(11, 45, 66, 0.08);
        --row-even: rgba(207, 31, 39, 0.06);
        --row-hover: rgba(11, 45, 66, 0.14);
      }

      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 24px; background: var(--brand-bg); color: var(--brand-text); }
      .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; align-items: start; }
      .card { border: 1px solid var(--brand-border); border-radius: 10px; padding: 16px; background: var(--brand-surface); }
      .row { display: grid; grid-template-columns: 140px 1fr; gap: 8px; margin-bottom: 10px; }
      input { width: 100%; padding: 8px; border: 1px solid var(--brand-border); border-radius: 8px; background: var(--brand-surface); color: var(--brand-text); }
      button { padding: 10px 12px; border: 0; border-radius: 10px; background: var(--brand-navy); color: white; cursor: pointer; }
      button:focus { outline: 2px solid rgba(207, 31, 39, 0.35); outline-offset: 2px; }
      table { width: 100%; border-collapse: collapse; }
      th, td { padding: 8px; border-bottom: 1px solid #eee; text-align: left; }
      tbody tr:nth-child(odd) td { background: var(--row-odd); }
      tbody tr:nth-child(even) td { background: var(--row-even); }
      tbody tr:hover td { background: var(--row-hover); }
      thead th { background: rgba(11, 45, 66, 0.10); }
      .muted { color: var(--brand-muted); font-size: 13px; }
      .warn { background: #fff7ed; }
      .error { background: #fef2f2; }
      .ok { background: #ecfdf5; }
      .tabs { display: flex; gap: 8px; flex-wrap: wrap; margin: 12px 0 16px; }
      .tab { background: #f1f5f9; border: 1px solid var(--brand-border); padding: 10px 12px; border-radius: 999px; cursor: pointer; color: var(--brand-text); }
      .tab[aria-selected="true"] { background: var(--brand-navy); color: white; border-color: var(--brand-navy); }
      .tab:hover { border-color: rgba(11, 45, 66, 0.35); }
      a { color: var(--brand-red); }
    </style>

    <script>
      function renderBarcodes(root){
        if(!window.JsBarcode){ return; }
        const container = root || document;
        const svgs = container.querySelectorAll('svg.barcode[data-code]:not([data-rendered="1"])');
        svgs.forEach(svg => {
          const code = svg.getAttribute('data-code') || '';
          if(!code){ return; }
          try {
            JsBarcode(svg, code, { format: 'CODE128', displayValue: false, height: 28, margin: 0, width: 1 });
            svg.setAttribute('data-rendered','1');
          } catch(e) {}
        });
      }

      window.renderMonthlyChart = function(root){
        const container = root || document;
        const el = container.querySelector('#monthly-chart');
        if(!el){ return; }

        const debugEl = container.querySelector('#monthly-chart-debug') || document.querySelector('#monthly-chart-debug');
        const dataEl = container.querySelector('#monthly-chart-data') || document.querySelector('#monthly-chart-data');
        const setDebug = (msg) => { if(debugEl){ debugEl.textContent = msg || ''; } };

        const attempt = (n) => {
          if(!window.Chart){
            setDebug('Cargando gráfica...');
            if(n > 0){ setTimeout(() => attempt(n - 1), 200); }
            if(n === 0){ setDebug('No se pudo cargar Chart.js (revisa conexión/CDN).'); }
            return;
          }

          let payload = null;
          try {
            payload = JSON.parse((dataEl && dataEl.textContent) ? dataEl.textContent : '{}');
          } catch(e) {
            setDebug('Error leyendo datos de gráfica.');
            return;
          }

          const labels = Array.isArray(payload.labels) ? payload.labels : [];
          const sales = Array.isArray(payload.sales) ? payload.sales : [];
          const purchases = Array.isArray(payload.purchases) ? payload.purchases : [];
          const profit = Array.isArray(payload.profit) ? payload.profit : [];

          if(window.__monthlyChart){ try { window.__monthlyChart.destroy(); } catch(e){} }
          window.__monthlyChart = new Chart(el.getContext('2d'), {
            type: 'bar',
            data: {
              labels,
              datasets: [
                { label: 'Ventas', data: sales, backgroundColor: 'rgba(11,45,66,0.85)' },
                { label: 'Compras', data: purchases, backgroundColor: 'rgba(203, 58, 66, 0.75)' },
                { label: 'Utilidad', data: profit, backgroundColor: 'rgba(16, 185, 129, 0.75)' },
              ]
            },
            options: {
              responsive: true,
              plugins: { legend: { position: 'bottom' } },
              scales: { x: { stacked: false }, y: { beginAtZero: true } }
            }
          });
          setDebug('');
        };

        attempt(15);
      }

      document.addEventListener('htmx:afterSwap', (evt) => {
        renderBarcodes(evt.target);
        window.renderMonthlyChart(evt.target);
      });
      document.addEventListener('DOMContentLoaded', () => {
        renderBarcodes(document);
        window.renderMonthlyChart(document);
      });
    </script>
  </head>
  <body>
    <h1 style="margin-bottom:6px;">Dashboard</h1>
    <p class="muted">La tabla se actualiza automáticamente. Si un SKU baja de stock mínimo, se marca.</p>

    <div class="tabs" role="tablist" aria-label="Secciones">
      <button class="tab" id="tab-home" aria-selected="true"
              hx-get="/ui/tabs/home" hx-target="#tab-content" hx-swap="innerHTML"
              hx-on:click="document.querySelectorAll('.tab').forEach(t=>t.setAttribute('aria-selected','false')); this.setAttribute('aria-selected','true');">
        Inicio
      </button>
      <button class="tab" id="tab-inventory" aria-selected="false"
              hx-get="/ui/tabs/inventory" hx-target="#tab-content" hx-swap="innerHTML"
              hx-on:click="document.querySelectorAll('.tab').forEach(t=>t.setAttribute('aria-selected','false')); this.setAttribute('aria-selected','true');">
        Inventario
      </button>
      <button class="tab" id="tab-purchases" aria-selected="false"
              hx-get="/ui/tabs/purchases" hx-target="#tab-content" hx-swap="innerHTML"
              hx-on:click="document.querySelectorAll('.tab').forEach(t=>t.setAttribute('aria-selected','false')); this.setAttribute('aria-selected','true');">
        Compras
      </button>
      <button class="tab" id="tab-sales" aria-selected="false"
              hx-get="/ui/tabs/sales" hx-target="#tab-content" hx-swap="innerHTML"
              hx-on:click="document.querySelectorAll('.tab').forEach(t=>t.setAttribute('aria-selected','false')); this.setAttribute('aria-selected','true');">
        Ventas
      </button>

      <button class="tab" id="tab-expenses" aria-selected="false"
              hx-get="/ui/tabs/expenses" hx-target="#tab-content" hx-swap="innerHTML"
              hx-on:click="document.querySelectorAll('.tab').forEach(t=>t.setAttribute('aria-selected','false')); this.setAttribute('aria-selected','true');">
        Costos operativos
      </button>
      <button class="tab" id="tab-profit-items" aria-selected="false"
              hx-get="/ui/tabs/profit-items" hx-target="#tab-content" hx-swap="innerHTML"
              hx-on:click="document.querySelectorAll('.tab').forEach(t=>t.setAttribute('aria-selected','false')); this.setAttribute('aria-selected','true');">
        Utilidades por artículo
      </button>

      <button class="tab" id="tab-profit" aria-selected="false"
              hx-get="/ui/tabs/profit" hx-target="#tab-content" hx-swap="innerHTML"
              hx-on:click="document.querySelectorAll('.tab').forEach(t=>t.setAttribute('aria-selected','false')); this.setAttribute('aria-selected','true');">
        Utilidades
      </button>

      <button class="tab" id="tab-dividends" aria-selected="false"
              hx-get="/ui/tabs/dividends" hx-target="#tab-content" hx-swap="innerHTML"
              hx-on:click="document.querySelectorAll('.tab').forEach(t=>t.setAttribute('aria-selected','false')); this.setAttribute('aria-selected','true');">
        Dividendos
      </button>

    </div>

    <div id="tab-content" class="card"
         hx-get="/ui/tabs/home" hx-trigger="load" hx-swap="innerHTML">
    </div>
  </body>
</html>
